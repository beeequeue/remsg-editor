import"./buffer-FAyrCndp.js";import{a as d}from"./vendor-CEDgS92X.js";var v=class{#e;#t=0;#r=!0;constructor(e=0){this.#e=d.Buffer.alloc(e)}get currentOffset(){return this.#t}get currentSize(){return this.#e.length}get buffer(){let e=d.Buffer.alloc(this.#e.length);return this.#e.copy(e),e}endianness(e){this.#r=e==="little"}grow(e){this.#e=d.Buffer.concat([this.#e,d.Buffer.alloc(e)])}growIfNeeded(e){this.#t+e>this.#e.length&&this.grow(this.#t+e-this.#e.length)}seek(e){let t=this.#t;return this.growIfNeeded(e),this.#t+=e,t}goto(e){let t=this.#t;return this.growIfNeeded(this.currentOffset-e),this.#t=e,t}alignTo(e){let t=this.#t%e;t!==0&&(this.growIfNeeded(e-t),this.#t+=e-t)}#n=(e,t,r)=>(i,o)=>{(o?.into==null||o.into+e>this.#e.length)&&this.growIfNeeded(e),this.#e[!this.#r&&r!=null?r:t](i,o?.into??this.#t,e),o?.into==null&&(this.#t+=e)};setInt8=this.#n(1,"writeInt8");setUint8=this.#n(1,"writeUInt8");setInt16=this.#n(2,"writeInt16LE","writeInt16BE");setUint16=this.#n(2,"writeUInt16LE","writeUInt16BE");setInt32=this.#n(4,"writeInt32LE","writeInt32BE");setUint32=this.#n(4,"writeUInt32LE","writeUInt32BE");setInt64=this.#n(8,"writeBigInt64LE","writeBigInt64BE");setUint64=this.#n(8,"writeBigUInt64LE","writeBigUInt64BE");setFloat=this.#n(4,"writeFloatLE","writeFloatBE");setDouble=this.#n(8,"writeDoubleLE","writeDoubleBE");setString(e,t){this.growIfNeeded(e.length),this.#e.write(e,t?.into??this.#t,"utf8"),t?.into==null&&(this.#t+=e.length)}setBuffer(e,t){this.growIfNeeded(e.length),e.copy(this.#e,t?.into??this.#t),t?.into==null&&(this.#t+=e.length)}},N=class{#e;#t=0;#r=!0;constructor(e){this.#e=e}get currentOffset(){return this.#t}endianness(e){this.#r=e==="little"}seek(e){let t=this.#t;return this.#t+=e,t}goto(e){let t=this.#t;return this.#t=e,t}alignTo(e){this.#t+=this.#t%e}readInt8(e){let t=new DataView(this.#e.buffer,e?.pointer??this.#t,1);return e?.pointer==null&&(this.#t+=1),t.getInt8(0)}readUint8(e){let t=new DataView(this.#e.buffer,e?.pointer??this.#t,1);return e?.pointer==null&&(this.#t+=1),t.getUint8(0)}readInt16(e){let t=new DataView(this.#e.buffer,e?.pointer??this.#t,2);return e?.pointer==null&&(this.#t+=2),t.getInt16(0,this.#r)}readUint16(e){let t=new DataView(this.#e.buffer,e?.pointer??this.#t,2);return e?.pointer==null&&(this.#t+=2),t.getUint16(0,this.#r)}readInt32(e){let t=new DataView(this.#e.buffer,e?.pointer??this.#t,4);return e?.pointer==null&&(this.#t+=4),t.getInt32(0,this.#r)}readUint32(e){let t=new DataView(this.#e.buffer,e?.pointer??this.#t,4);return e?.pointer==null&&(this.#t+=4),t.getUint32(0,this.#r)}readInt64(e){let t=new DataView(this.#e.buffer,e?.pointer??this.#t,8);return e?.pointer==null&&(this.#t+=8),t.getBigInt64(0,this.#r)}readUint64(e){let t=new DataView(this.#e.buffer,e?.pointer??this.#t,8);return e?.pointer==null&&(this.#t+=8),t.getBigUint64(0,this.#r)}readFloat(e){let t=new DataView(this.#e.buffer,e?.pointer??this.#t,4);return e?.pointer==null&&(this.#t+=4),t.getFloat32(0,this.#r)}readDouble(e){let t=new DataView(this.#e.buffer,e?.pointer??this.#t,8);return e?.pointer==null&&(this.#t+=8),t.getFloat64(0,this.#r)}readBuffer(e){let t=this.#e.subarray(this.#t,this.#t+e.length);return e.pointer==null&&(this.#t+=e.length),t}readString(e){let t;if("length"in e&&(t=this.readBuffer(e)),"zeroed"in e){let r=new DataView(this.#e.buffer,this.#t),i=0;for(;r.getUint8(this.#t+i)!==0;)i++;t=this.#e.subarray(0,i),this.#t+=i}return new TextDecoder().decode(t)}},$=e=>{let t=e.toString("hex");return[t.slice(6,8)+t.slice(4,6)+t.slice(2,4)+t.slice(0,2),t.slice(10,12)+t.slice(8,10),t.slice(14,16)+t.slice(12,14),t.slice(16,18)+t.slice(18,20),t.slice(20,32)].join("-")},D=e=>{let t=e.replaceAll("-","");return d.Buffer.from([t.slice(6,8)+t.slice(4,6)+t.slice(2,4)+t.slice(0,2),t.slice(10,12)+t.slice(8,10),t.slice(14,16)+t.slice(12,14),t.slice(16,18)+t.slice(18,20),t.slice(20,32)].join(""),"hex")},V=(e,t)=>{if(e.length===0)return new Map;let r=e.toString("utf16le");if(r.at(-1)!=="\0")throw new Error("String is not null-terminated");let i=new Map,o=0;for(let c=0;c<r.length;c++)r[c]==="\0"&&(i.set(t+o*2,r.slice(o,c)),o=c+1);return i},C=(e,t)=>{let r=0,i=new Map,o=u=>{if(i.has(u))return i.get("str");let n=t+r;return i.set(u,n),r+=u.length*2+2,n},c=[],g=[];for(let u=0;u<e.meta.attributes.length;u++){let n=e.meta.attributes[u];n.type===-1?(o(""),c.push(u)):n.type===2&&(o(n.name),g.push(u))}for(let u=0;u<e.meta.attributes.length;u++){let n=e.meta.attributes[u];o(n.name)}for(let u of e.entries){o(u.name);for(let n of Object.values(u.strings))o(n);for(let n of g)o(u.attributes[n])}let l=d.Buffer.alloc(0);for(let u of i.keys()){let n=d.Buffer.from(`${u}\0`,"utf16le");l=d.Buffer.concat([l,n])}return{map:i,nullAttributes:c,stringAttributes:g,data:l}},O=[207,206,251,248,236,10,51,102,147,169,29,147,80,57,95,9],L=e=>{let t=d.Buffer.from(e),r=0;for(let i=0;i<t.length;i++){let o=t[i];t[i]=o^r^O[i&15],r=o}return t},S=e=>{let t=d.Buffer.from(e),r=0;for(let i=0;i<t.length;i++){let o=t[i];t[i]=o^r^O[i&15],r=t[i]}return t},j=e=>{if(e.meta.version!==539100710)throw new Error(`Unsupported version ${e.meta.version}`);let t=new v;t.setUint32(e.meta.version),t.setString("GMSG"),t.setUint64(16n),t.setUint32(e.entries.length),t.setUint32(e.meta.attributes.length);let r=e.entries[0]!=null?Object.keys(e.entries[0].strings).length:0;t.setUint32(r),t.alignTo(8);let i=t.currentOffset;t.setInt64(-1n);let o=t.currentOffset;t.setInt64(-1n);let c=t.currentOffset;t.setInt64(-1n);let g=t.currentOffset;t.setInt64(-1n);let l=t.currentOffset;t.setInt64(-1n);let u=[];for(let a=0;a<e.entries.length;a++)u.push(t.currentOffset),t.setInt64(-1n);t.setUint64(BigInt(t.currentOffset),{into:o}),t.setUint64(0n),t.setUint64(BigInt(t.currentOffset),{into:c});for(let a=0;a<r;a++)t.setUint32(a);t.alignTo(8),t.setUint64(BigInt(t.currentOffset),{into:g});for(let a of e.meta.attributes)t.setInt32(a.type);t.alignTo(8),t.setUint64(BigInt(t.currentOffset),{into:l});let n=[];for(let a of e.meta.attributes)n.push(t.currentOffset),t.setInt64(-1n);let s=[];for(let a=0;a<e.entries.length;a++){t.setUint64(BigInt(t.currentOffset),{into:u[a]});let b=e.entries[a];t.setBuffer(D(b.meta.id)),t.setUint32(b.meta.crc),t.setUint32(b.meta.hash),s[a]??={},s[a].name=t.currentOffset,t.setInt64(-1n),s[a].attributes=t.currentOffset,t.setInt64(-1n),s[a].langs=[];for(let h=0;h<r;h++)s[a].langs[h]=t.currentOffset,t.setInt64(-1n);s[a].attributeValues=[]}for(let a=0;a<e.entries.length;a++){let b=e.entries[a];t.setUint64(BigInt(t.currentOffset),{into:s[a].attributes});for(let h=0;h<e.meta.attributes.length;h++){switch(e.meta.attributes[h].type){case-1:t.setInt64(-1n);break;case 0:t.setInt32(b.attributes[h]);break;case 1:t.setDouble(b.attributes[h]);break;case 2:t.setInt64(-1n);break}s[a].attributeValues[h]=t.currentOffset}}let f=t.currentOffset;t.setUint64(BigInt(f),{into:i});let{data:w,map:U,nullAttributes:B,stringAttributes:y}=C(e,f),E=S(w);t.setBuffer(E);for(let a=0;a<e.meta.attributes.length;a++){let{name:b}=e.meta.attributes[a],h=n[a];t.setUint64(BigInt(U.get(b)),{into:h})}for(let a=0;a<e.entries.length;a++){let b=e.entries[a],h=s[a];t.setUint64(BigInt(U.get(b.name)),{into:h.name});let I=Object.values(b.strings);for(let m=0;m<I.length;m++){let p=I[m];t.setUint64(BigInt(U.get(p)),{into:h.langs[m]})}for(let m of y){let p=b.attributes[m];t.setUint64(BigInt(U.get(p)),{into:h.attributeValues[m]})}let k=U.get("");for(let m of B)t.setUint64(BigInt(k),{into:h.attributeValues[m]})}return t.buffer},T=["ja","en","fr","it","de","es","ru","pl","nl","pt","pt-br","ko","zh-tw","zh-cn","fi","sv","da","no","cs","hu","sk","ar","tr","bg","el","ro","th","uk","vi","id","fiction","hi","es-mx","max"],A=e=>({version:e.readUint32(),magic:e.readString({length:4}),headerOffset:e.readUint64(),entryCount:e.readUint32(),attributeCount:e.readUint32(),langCount:e.readUint32(),_:e.alignTo(8),dataOffset:e.readUint64(),_2:e.seek(8),langOffset:e.readUint64(),attributesOffset:e.readUint64(),attributeNamesOffset:e.readUint64()}),M=e=>{let t=new N(e),r=A(t),i=[];if(r.magic!=="GMSG")throw new Error(`Invalid magic: ${r.magic}`);if(r.version!==539100710)throw new Error(`Uknkown version: ${r.version}`);let o=[];for(let l=0;l<r.entryCount;l++)o.push(t.readUint64());t.seek(8);let c=[];for(let l=0;l<r.langCount;l++)c.push(T[t.readUint32()]);if(t.alignTo(8),Number(r.attributesOffset)!==t.currentOffset)throw new Error(`Attributes offset mismatch: ${r.attributesOffset} != ${t.currentOffset}`);let g=[];for(let l=0;l<r.attributeCount;l++)g.push({type:t.readInt32(),nameOffset:null,name:null});if(t.alignTo(8),Number(r.attributeNamesOffset)!==t.currentOffset)throw new Error(`Attribute names offset mismatch: ${r.attributeNamesOffset} != ${t.currentOffset}`);for(let l=0;l<r.attributeCount;l++)g[l].nameOffset=t.readUint64();if(r.entryCount!==0){for(let n=0;n<r.entryCount;n++){if(Number(o[n])!==t.currentOffset)throw new Error(`Entry header offset mismatch: $${t.currentOffset} != entry:${n}:${o[n]}`);let s={id:$(t.readBuffer({length:16})),crc:t.readUint32(),hash:t.readUint32(),nameOffset:t.readUint64(),attributesOffset:t.readUint64(),contentOffsetsByLang:[]};for(let f=0;f<r.langCount;f++)s.contentOffsetsByLang.push(t.readUint64());i.push({header:s})}for(let n=0;n<r.entryCount;n++){let s=i[n];if(Number(s.header.attributesOffset)!==t.currentOffset)throw new Error(`Entry header attributes offset mismatch: $${t.currentOffset} != entry:${n}:${s.header.attributesOffset}`);s.attributes=[];for(let f=0;f<g.length;f++){let w=g[f];switch(w.type){case-1:s.attributes[f]=Number(t.readUint64());break;case 0:s.attributes[f]=t.readUint32(),t.seek(4);break;case 1:s.attributes[f]=t.readDouble();break;case 2:s.attributes[f]=Number(t.readUint64());break;default:throw new Error(`Not implemented attribute type ${w.type}`)}}}if(Number(r.dataOffset)!==t.currentOffset)throw new Error(`Data offset mismatch: $${r.dataOffset} != ${t.currentOffset}`);let l=L(e.subarray(t.currentOffset)),u=V(l,t.currentOffset);for(let n=0;n<g.length;n++){let s=g[n];s.name=u.get(Number(s.nameOffset))}for(let n=0;n<i.length;n++){let s=i[n];for(let f=0;f<r.attributeCount;f++)switch(g[f].type){case 2:s.attributes[f]=u.get(s.attributes[f]);break;case-1:if(s.attributes[f]=u.get(s.attributes[f]),s.attributes[f]!==""&&s.attributes[f]!=="\0")throw new Error(`Attribute with type -1 is not empty string: "${s.attributes[f]}"`);break}}for(let n=0;n<i.length;n++){let s=i[n];s.name=u.get(Number(s.header.nameOffset)),s.strings={};for(let f=0;f<s.header.contentOffsetsByLang.length;f++){let w=Number(s.header.contentOffsetsByLang[f]);s.strings[c[f]]=u.get(w)}}}return{meta:{version:r.version,attributes:g.map(l=>({type:l.type,name:l.name}))},entries:i.map(l=>({meta:{id:l.header.id,crc:l.header.crc,hash:l.header.hash},name:l.name,attributes:l.attributes,strings:l.strings}))}};export{M as F,j as T};
